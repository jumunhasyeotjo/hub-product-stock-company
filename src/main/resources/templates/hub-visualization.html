<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌóàÎ∏å ÎÑ§Ìä∏ÏõåÌÅ¨ ÏãúÍ∞ÅÌôî</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: #667eea;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            padding: 25px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .stat-item {
            text-align: center;
            padding: 15px 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 150px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.95em;
            color: #6c757d;
            font-weight: 600;
        }

        .visualization-container {
            position: relative;
            padding: 20px;
            background: white;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 30px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        #visualization {
            width: 100%;
            height: 800px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: #fafafa;
            cursor: grab;
        }

        #visualization:active {
            cursor: grabbing;
        }

        .legend {
            position: absolute;
            top: 40px;
            right: 40px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 0.95em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .tooltip-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
            color: #4CAF50;
        }

        .tooltip-content {
            line-height: 1.6;
        }

        .zoom-controls {
            position: absolute;
            bottom: 40px;
            right: 40px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            border: none;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            color: #667eea;
        }

        .zoom-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: #667eea;
            color: white;
        }

        /* ÎÖ∏Îìú Î∞è ÎßÅÌÅ¨ Ïä§ÌÉÄÏùº */
        .link {
            stroke: #4CAF50;
            stroke-opacity: 0.6;
            stroke-width: 2;
        }

        .link:hover {
            stroke-opacity: 1;
            stroke-width: 3;
        }

        .node-center {
            fill: #4CAF50;
            stroke: #2E7D32;
            stroke-width: 3;
            cursor: pointer;
        }

        .node-branch {
            fill: #2196F3;
            stroke: #1565C0;
            stroke-width: 3;
            cursor: pointer;
        }

        .node:hover {
            stroke-width: 5;
            filter: brightness(1.2);
        }

        .node-label {
            font-size: 13px;
            font-weight: 600;
            fill: #333;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white;
        }

        .link-label {
            font-size: 11px;
            fill: #666;
            text-anchor: middle;
            pointer-events: none;
            font-weight: 600;
            text-shadow: 
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöö ÌóàÎ∏å ÎÑ§Ìä∏ÏõåÌÅ¨ ÏãúÍ∞ÅÌôî</h1>
            <p>Î¨ºÎ•ò ÌóàÎ∏å Í∞Ñ Ïó∞Í≤∞ Í¥ÄÍ≥Ñ Î∞è Í≤ΩÎ°ú Ï†ïÎ≥¥</p>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" th:text="${visualizationData.totalHubs}">0</div>
                <div class="stat-label">Ï¥ù ÌóàÎ∏å</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" th:text="${visualizationData.centerHubCount}">0</div>
                <div class="stat-label">ÏÑºÌÑ∞ ÌóàÎ∏å</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" th:text="${visualizationData.branchHubCount}">0</div>
                <div class="stat-label">ÏßÄÏ†ê ÌóàÎ∏å</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" th:text="${visualizationData.totalRoutes}">0</div>
                <div class="stat-label">Ïó∞Í≤∞ Í≤ΩÎ°ú</div>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="resetVisualization()">üîÑ Ï¥àÍ∏∞Ìôî</button>
            <button class="control-btn" onclick="toggleLabels()">üè∑Ô∏è Î†àÏù¥Î∏î ÌÜ†Í∏Ä</button>
            <button class="control-btn" onclick="toggleDistance()">üìè Í±∞Î¶¨ ÌëúÏãú</button>
            <button class="control-btn" onclick="centerView()">üéØ Ï§ëÏïô Ï†ïÎ†¨</button>
        </div>

        <div class="visualization-container">
            <svg id="visualization"></svg>
            
            <div class="legend">
                <div class="legend-title">Î≤îÎ°Ä</div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4CAF50; border-color: #2E7D32;"></div>
                    <span>ÏÑºÌÑ∞ ÌóàÎ∏å (CENTER)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2196F3; border-color: #1565C0;"></div>
                    <span>ÏßÄÏ†ê ÌóàÎ∏å (BRANCH)</span>
                </div>
            </div>

            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // ThymeleafÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Ï†ÑÎã¨
        const hubsData = /*[[${visualizationData.hubs}]]*/ [];
        const routesData = /*[[${visualizationData.routes}]]*/ [];
        
        // D3.js Î≥ÄÏàò
        let svg, g, gLabels, simulation;
        let showLabels = true;
        let showDistance = true;
        let zoom;
        let currentTransform = d3.zoomIdentity;

        // Ï¥àÍ∏∞Ìôî
        function initVisualization() {
            const container = document.getElementById('visualization');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // SVG Ï¥àÍ∏∞Ìôî
            d3.select('#visualization').selectAll('*').remove();
            
            svg = d3.select('#visualization')
                .attr('width', width)
                .attr('height', height);

            // Ï§å ÏÑ§Ï†ï
            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    currentTransform = event.transform;
                    // ÎÖ∏ÎìúÏôÄ ÎßÅÌÅ¨Îßå Î≥ÄÌôò (Í∏ÄÏûêÎäî Ï†úÏô∏)
                    g.attr('transform', event.transform);
                    // Í∏ÄÏûêÎäî ÏúÑÏπòÎßå Ïù¥Îèô, ÌÅ¨Í∏∞Îäî Ï§åÏóê Î∞òÎπÑÎ°ÄÌïòÏó¨ Ï°∞Ï†ï
                    updateLabelsTransform(event.transform);
                });

            svg.call(zoom);

            // ÎÖ∏Îìú/ÎßÅÌÅ¨ Í∑∏Î£π
            g = svg.append('g');
            // Î†àÏù¥Î∏î Í∑∏Î£π (Î≥ÑÎèÑ)
            gLabels = svg.append('g');

            // ÎÖ∏Îìú Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
            const nodes = hubsData.map(hub => ({
                id: hub.hubId,
                name: hub.name,
                type: hub.type,
                lat: hub.latitude,
                lon: hub.longitude,
                address: hub.address
            }));

            // ÎßÅÌÅ¨ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
            const links = routesData.map(route => ({
                source: route.fromHubId,
                target: route.toHubId,
                distance: route.distance,
                duration: route.duration
            }));

            // Ï¢åÌëú Î≥ÄÌôò (ÏúÑÍ≤ΩÎèÑ -> SVG Ï¢åÌëú)
            const latExtent = d3.extent(nodes, d => d.lat);
            const lonExtent = d3.extent(nodes, d => d.lon);
            
            const padding = 100;
            const xScale = d3.scaleLinear()
                .domain(lonExtent)
                .range([padding, width - padding]);
            
            const yScale = d3.scaleLinear()
                .domain(latExtent)
                .range([height - padding, padding]);

            // ÎÖ∏Îìú ÏúÑÏπò Ï¥àÍ∏∞Ìôî
            nodes.forEach(node => {
                node.x = xScale(node.lon);
                node.y = yScale(node.lat);
                node.fx = node.x; // Í≥†Ï†ï ÏúÑÏπò
                node.fy = node.y;
            });

            // Force Simulation
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('collision', d3.forceCollide().radius(50));

            // ÎßÅÌÅ¨ Í∑∏Î¶¨Í∏∞
            const link = g.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('class', 'link')
                .attr('stroke-width', 2);

            // ÎÖ∏Îìú Í∑∏Î¶¨Í∏∞
            const node = g.append('g')
                .selectAll('circle')
                .data(nodes)
                .join('circle')
                .attr('class', d => d.type === 'CENTER' ? 'node node-center' : 'node node-branch')
                .attr('r', d => d.type === 'CENTER' ? 14 : 10)
                .call(drag(simulation));

            // ÎßÅÌÅ¨ Î†àÏù¥Î∏î (Í±∞Î¶¨) - Î≥ÑÎèÑ Í∑∏Î£π
            const linkLabel = gLabels.append('g')
                .selectAll('text')
                .data(links)
                .join('text')
                .attr('class', 'link-label')
                .style('display', showDistance ? 'block' : 'none')
                .text(d => `${d.distance.toFixed(1)}km`);

            // ÎÖ∏Îìú Î†àÏù¥Î∏î - Î≥ÑÎèÑ Í∑∏Î£π
            const nodeLabel = gLabels.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .attr('class', 'node-label')
                .style('display', showLabels ? 'block' : 'none')
                .text(d => d.name);

            // Ìà¥ÌåÅ
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);

            node.on('mouseover', function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style('opacity', 1);
                tooltip.html(`
                    <div class="tooltip-title">${d.name}</div>
                    <div class="tooltip-content">
                        <strong>ÌÉÄÏûÖ:</strong> ${d.type}<br>
                        <strong>Ï£ºÏÜå:</strong> ${d.address}<br>
                        <strong>Ï¢åÌëú:</strong> ${d.lat.toFixed(4)}, ${d.lon.toFixed(4)}
                    </div>
                `)
                    .style('left', (event.pageX + 15) + 'px')
                    .style('top', (event.pageY - 15) + 'px');
            })
            .on('mouseout', function() {
                tooltip.transition()
                    .duration(500)
                    .style('opacity', 0);
            });

            link.on('mouseover', function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style('opacity', 1);
                tooltip.html(`
                    <div class="tooltip-content">
                        <strong>Í±∞Î¶¨:</strong> ${d.distance.toFixed(2)} km<br>
                        <strong>ÏãúÍ∞Ñ:</strong> ${d.duration} Î∂Ñ
                    </div>
                `)
                    .style('left', (event.pageX + 15) + 'px')
                    .style('top', (event.pageY - 15) + 'px');
            })
            .on('mouseout', function() {
                tooltip.transition()
                    .duration(500)
                    .style('opacity', 0);
            });

            // Simulation ÏóÖÎç∞Ïù¥Ìä∏
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                // Î†àÏù¥Î∏î ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
                updateLabels(linkLabel, nodeLabel);
            });
        }

        // Î†àÏù¥Î∏î ÏúÑÏπò Î∞è ÌÅ¨Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateLabels(linkLabel, nodeLabel) {
            const scale = currentTransform.k;
            const tx = currentTransform.x;
            const ty = currentTransform.y;

            // ÎßÅÌÅ¨ Î†àÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
            linkLabel
                .attr('x', d => (d.source.x + d.target.x) / 2 * scale + tx)
                .attr('y', d => (d.source.y + d.target.y) / 2 * scale + ty)
                .style('font-size', `${11 / Math.sqrt(scale)}px`);  // Ï§åÏóê Î∞òÎπÑÎ°Ä

            // ÎÖ∏Îìú Î†àÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
            nodeLabel
                .attr('x', d => d.x * scale + tx)
                .attr('y', d => (d.y - 20) * scale + ty)
                .style('font-size', `${13 / Math.sqrt(scale)}px`);  // Ï§åÏóê Î∞òÎπÑÎ°Ä
        }

        // Ï§å Ïãú Î†àÏù¥Î∏î Î≥ÄÌôò
        function updateLabelsTransform(transform) {
            const scale = transform.k;
            const tx = transform.x;
            const ty = transform.y;

            // Î™®Îì† ÎßÅÌÅ¨ Î†àÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
            d3.selectAll('.link-label')
                .attr('x', function() {
                    const d = d3.select(this).datum();
                    return (d.source.x + d.target.x) / 2 * scale + tx;
                })
                .attr('y', function() {
                    const d = d3.select(this).datum();
                    return (d.source.y + d.target.y) / 2 * scale + ty;
                })
                .style('font-size', `${11 / Math.sqrt(scale)}px`);

            // Î™®Îì† ÎÖ∏Îìú Î†àÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
            d3.selectAll('.node-label')
                .attr('x', function() {
                    const d = d3.select(this).datum();
                    return d.x * scale + tx;
                })
                .attr('y', function() {
                    const d = d3.select(this).datum();
                    return (d.y - 20) * scale + ty;
                })
                .style('font-size', `${13 / Math.sqrt(scale)}px`);
        }

        // ÎìúÎûòÍ∑∏ Í∏∞Îä•
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
            }

            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }

        // Ïª®Ìä∏Î°§ Ìï®ÏàòÎì§
        function resetVisualization() {
            currentTransform = d3.zoomIdentity;
            initVisualization();
        }

        function toggleLabels() {
            showLabels = !showLabels;
            d3.selectAll('.node-label')
                .style('display', showLabels ? 'block' : 'none');
        }

        function toggleDistance() {
            showDistance = !showDistance;
            d3.selectAll('.link-label')
                .style('display', showDistance ? 'block' : 'none');
        }

        function centerView() {
            currentTransform = d3.zoomIdentity;
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity);
        }

        function zoomIn() {
            svg.transition()
                .duration(300)
                .call(zoom.scaleBy, 1.3);
        }

        function zoomOut() {
            svg.transition()
                .duration(300)
                .call(zoom.scaleBy, 0.7);
        }

        // Ï∞Ω ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Ïãú Ïû¨Î†åÎçîÎßÅ
        window.addEventListener('resize', () => {
            currentTransform = d3.zoomIdentity;
            initVisualization();
        });

        // Ï¥àÍ∏∞ Î°úÎìú
        document.addEventListener('DOMContentLoaded', () => {
            initVisualization();
        });
        /*]]>*/
    </script>
</body>
</html>
