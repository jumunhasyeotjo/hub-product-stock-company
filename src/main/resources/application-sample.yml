server:
  port: 8088

spring:
  config:
    import: optional:file:./.env[.properties]
  application:
    name: hub-product-stock-company
  profiles:
    active: dev

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 3000ms
      ssl:
        enabled: true  # TLS 활성화

  datasource:
    url: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
    username: ${POSTGRES_USERNAME}
    password: ${POSTGRES_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: ${DB_POOL_SIZE:10}
      connection-timeout: ${DB_CONNECTION_TIMEOUT:3000}
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    defer-datasource-initialization: true
    properties:
      jakarta.persistence.lock.timeout: ${DB_LOCK_TIME_OUT:2000}
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.PostgreSQLDialect
    database-platform: org.hibernate.dialect.PostgreSQLDialect

  sql:
    init:
      mode: always

  kafka:
    # 브로커 주소
    bootstrap-servers: localhost:9092
    # 토픽 설정 (커스텀)
    topics:
      hub: hub
      order: order
    producer:
      retries: 3
    consumer:
      # 컨슈머 그룹
      group-id: hub-service-group

logging:
#  level:
#    org.hibernate.orm.jdbc.bind: TRACE      # 바인딩값 로그
#    org.hibernate.SQL: DEBUG
#    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
#    org.springframework.orm.jpa: DEBUG
#    org.springframework.transaction: DEBUG


cache:
  config:
    hubService: ${HUB_SERVICE_CACHEABLE:true}  # true면 캐시주입, false면 원본 Service 주입

kakao:
  mobility:
    api-key: ${KAKAO_MOBILITY_API_KEY}

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
    register-with-eureka: true
    fetch-registry: true
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}


resilience4j:
  circuitbreaker:
    instances:
      redisIdempotency:
        registerHealthIndicator: true  # Actuator health endpoint에 Circuit Breaker 상태 노출 (/actuator/health)
        slidingWindowSize: 10  # 실패율 계산을 위해 추적할 최근 호출 개수 (최근 10개) 낮은 트래픽 가정
        minimumNumberOfCalls: 5  # 실패율 계산 전 필요한 최소 호출 수 (5번 미만이면 무조건 CLOSED)
        failureRateThreshold: 50  # Circuit OPEN 전환 실패율 임계값 (50% 이상 실패 시 OPEN)
        waitDurationInOpenState: 10s  # OPEN 상태 유지 시간 (30초 후 HALF_OPEN으로 전환)
        permittedNumberOfCallsInHalfOpenState: 5  # HALF_OPEN 상태에서 허용할 테스트 호출 수
        automaticTransitionFromOpenToHalfOpenEnabled: true  # OPEN → HALF_OPEN 자동 전환 활성화 minimumNumberOfCalls과동일
        recordExceptions:  # 실패로 기록할 예외 목록 (이 예외들만 실패율 계산에 포함)
          - org.springframework.data.redis.RedisConnectionFailureException  # Redis 연결 실패
          - java.net.ConnectException  # 네트워크 연결 실패
          - java.io.IOException  # I/O 예외
      redisCache:
        registerHealthIndicator: true
        slidingWindowSize: 10          # 최근 10개 호출 추적
        minimumNumberOfCalls: 5        # 최소 5번 호출 후 실패율 계산
        failureRateThreshold: 50       # 50% 실패 시 Circuit OPEN
        waitDurationInOpenState: 10s   # OPEN 상태 10초 유지
        permittedNumberOfCallsInHalfOpenState: 3  # HALF_OPEN에서 3번 테스트
        automaticTransitionFromOpenToHalfOpenEnabled: true
        recordExceptions:
          - org.springframework.data.redis.RedisConnectionFailureException
          - org.springframework.data.redis.RedisSystemException
          - java.net.SocketTimeoutException
          - java.net.ConnectException
          - java.io.IOException
  retry:
    instances:
      redisIdempotency:
        maxAttempts: 3  # 최대 3번 시도 (첫 시도 + 재시도 2번)
        waitDuration: 500ms  # 재시도 간격 500ms
        enableExponentialBackoff: true  # 지수 백오프 활성화
        exponentialBackoffMultiplier: 2  # 2배씩 증가 (500ms → 1s → 2s)
        retryExceptions: # 이 예외들만 재시도
          - org.springframework.data.redis.RedisConnectionFailureException
          - java.net.ConnectException
          - java.io.IOException

eas:
  passport:
    secretKey: ${PASSPORT_SECRET}
    expiration: ${PASSPORT_EXPIRATION:604800}
    algorithm: ${PASSPORT_ALGO}
---
# test profile
spring:
  config:
    activate:
      on-profile: test
  data:
    redis:
      ssl:
        enabled: false  # Testcontainers Redis는 SSL 미지원

  # Testcontainers가 실제 값으로 오버라이드하지만, placeholder 에러 방지용 더미 값
  datasource:
    url: jdbc:postgresql://localhost:5432/testdb
    username: testuser
    password: testpass
    hikari:
      maximum-pool-size: 30
  kafka:
    # 브로커 주소
    bootstrap-servers: localhost:9092
    # 토픽 설정 (커스텀)
    topics:
      hub: hub
      order: order
    producer:
      retries: 3
    consumer:
      # 컨슈머 그룹
      group-id: hub-service-group
cache:
  config:
    hubService: true  # 테스트에서 캐시 기능 테스트

kakao:
  mobility:
    api-key: dummy-kakao-api-key-for-test  # 테스트용 더미 값

logging:
  level:
    # Hibernate binding 로그
    org.hibernate.orm.jdbc.bind: error
    org.hibernate.type.descriptor.sql.BasicBinder: error
    # Hibernate SQL
    org.hibernate.SQL: error
    org.springframework.orm.jpa: error
    org.springframework.transaction: error

---
# local profile
spring:
  config:
    activate:
      on-profile: local
eureka:
  client:
    enabled: false
    register-with-eureka: false
    fetch-registry: false
---
spring:
  config:
    activate:
      on-profile: dev

eureka:
  client:
    enabled: false

management:
  endpoints:
    web:
      exposure:
        include: "*"

springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html