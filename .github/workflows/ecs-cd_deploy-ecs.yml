name: ecs CI/CD _ Deploy Ecs
on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
      ecs-cluster:
        required: true
        type: string
      ecs-service:
        required: true
        type: string
      parameter-path:
        required: true
        type: string
      image-uri:
        required: true
        type: string
      aws-region:
        required: true
        type: string
    secrets:
      aws-access-key-id:
        required: true
      aws-secret-access-key:
        required: true

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: hub-aws

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}

      - name: pull νλΌλ―Έν„° μ¤ν† μ–΄ κ°’
        run: |
          aws ssm get-parameters-by-path \
            --path "${{ inputs.parameter-path }}" \
            --recursive \
            --with-decryption \
            --region ${{ inputs.aws-region }} \
            --output json > parameters.json

      - name: Download ν…μ¤ν¬ μ •μ
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ inputs.ecs-service }} \
            --query taskDefinition \
            > task-definition.json

      - name: ν…μ¤ν¬ μ •μ ν™κ²½ λ³€μ κ°±μ‹ 
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          
          with open('task-definition.json', 'r') as f:
              task_def = json.load(f)
          
          with open('parameters.json', 'r') as f:
              params_data = json.load(f)
          
          env_vars = []
          for param in params_data.get('Parameters', []):
              key = param['Name'].split('/')[-1]
              value = param['Value']
              env_vars.append({"name": key, "value": value})
          
          container = None
          for cont in task_def['containerDefinitions']:
              if cont['name'] == '${{ inputs.service-name }}':
                  container = cont
                  break
          
          if container is None:
              print(f"β Container not found!")
              sys.exit(1)
          
          container['environment'] = env_vars
          
          for key in ['taskDefinitionArn', 'revision', 'status', 
                      'requiresAttributes', 'compatibilities', 
                      'registeredAt', 'registeredBy']:
              task_def.pop(key, None)
          
          with open('task-definition-updated.json', 'w') as f:
              json.dump(task_def, f, indent=2)
          PYTHON_SCRIPT

      - name: Upload ν…μ¤ν¬ μ •μ
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition-updated.json
          container-name: ${{ inputs.service-name }}
          image: ${{ inputs.image-uri }}

      - name: Deploy to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ inputs.ecs-service }}
          cluster: ${{ inputs.ecs-cluster }}
          wait-for-service-stability: true

      - name: λ°°ν¬ μ„±κ³µ κ²€μ¦
        run: |
          EXPECTED_TASK_DEF="${{ steps.deployed-task-def.outputs.task-def-arn }}"
          echo "π“ Expected Task Definition: $EXPECTED_TASK_DEF"
          
          for i in {1..12}; do
            sleep 5
            echo ""
            echo "β±οΈ  Check $i/12..."
          
            SERVICE=$(aws ecs describe-services \
              --cluster ${{ inputs.ecs-cluster }} \
              --services ${{ inputs.ecs-service }} \
              --output json)
          
            # μ‹¤μ  λ°°ν¬λμ–΄ μλ” Task Definition
            DEPLOYED_TASK_DEF=$(echo $SERVICE | jq -r '.services[0].taskDefinition')
          
            # PRIMARY λ°°ν¬μ μƒνƒ
            DEPLOYMENT_STATUS=$(echo $SERVICE | jq -r '.services[0].deployments[] | select(.status=="PRIMARY") | .rolloutState // "IN_PROGRESS"')
          
            echo "  Expected:   $EXPECTED_TASK_DEF"
            echo "  Deployed:   $DEPLOYED_TASK_DEF"
            echo "  Status:     $DEPLOYMENT_STATUS"
          
            # λ΅¤λ°± μ²΄ν¬: λ°°ν¬λμ–΄ μλ” κ² μƒμ„±ν• κ²ƒκ³Ό λ‹¤λ¥΄λ©΄
            if [ "$DEPLOYED_TASK_DEF" != "$EXPECTED_TASK_DEF" ]; then
              echo ""
              echo "β ROLLBACK DETECTED!"
              echo "   Expected: $EXPECTED_TASK_DEF"
              echo "   Deployed: $DEPLOYED_TASK_DEF"
              exit 1
            fi
          
            # μ‹¤ν¨ μ²΄ν¬
            if [ "$DEPLOYMENT_STATUS" == "FAILED" ]; then
              echo ""
              echo "β DEPLOYMENT FAILED!"
              exit 1
            fi
          
            # μ„±κ³µ μ²΄ν¬: μƒμ„±ν• Taskκ°€ λ°°ν¬λμ–΄ μκ³  μƒνƒκ°€ COMPLETED
            if [ "$DEPLOYMENT_STATUS" == "COMPLETED" ]; then
              echo ""
              echo "β… DEPLOYMENT COMPLETED!"
              echo "   Task Definition: $DEPLOYED_TASK_DEF"
              echo "   Status: $DEPLOYMENT_STATUS"
              exit 0
            fi
          
            echo "  β†’ Deployment in progress..."
          done
          
          echo ""
          echo "β±οΈ  TIMEOUT: Deployment did not complete in 60 seconds"
          exit 1

      - name: Verify
        run: echo "β… Deployed successfully!"