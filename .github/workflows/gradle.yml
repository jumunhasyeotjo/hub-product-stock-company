name: Java CI/CD with Gradle

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: read  # for passport custom lib
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build with Gradle (including Testcontainers tests)
      env:
        GITHUB_USERNAME: ${{ secrets.GH_USERNAME }}
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
        POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        REDIS_HOST: ${{ secrets.REDIS_HOST }}
        REDIS_PORT: ${{ secrets.REDIS_PORT }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      run: ./gradlew clean build
    
    - name: Stop existing application
      run: |
        echo "Stopping existing application on port 8088..."
        PID=$(lsof -ti:8088) || true
        if [ ! -z "$PID" ]; then
          echo "Found process $PID running on port 8088"
          kill -15 $PID
          sleep 5
          if lsof -ti:8088 > /dev/null; then
            echo "Process still running, forcing kill..."
            kill -9 $(lsof -ti:8088)
          fi
          echo "Application stopped successfully"
        else
          echo "No application running on port 8088"
        fi
    
    - name: Deploy new version
      run: |
        JAR_PATH="build/libs/hub_prodcut_stock_company-0.0.1-SNAPSHOT.jar"
        DEPLOY_DIR="$HOME/deploy"
        
        mkdir -p $DEPLOY_DIR
        
        if [ -f "$DEPLOY_DIR/app.jar" ]; then
          mv "$DEPLOY_DIR/app.jar" "$DEPLOY_DIR/app.jar.bak.$(date +%Y%m%d_%H%M%S)"
        fi
        
        cp $JAR_PATH $DEPLOY_DIR/app.jar
        echo "Deployed new version to $DEPLOY_DIR/app.jar"
    
    - name: Start application
      env:
        POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
        POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        REDIS_HOST: ${{ secrets.REDIS_HOST }}
        REDIS_PORT: ${{ secrets.REDIS_PORT }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        DB_CONNECTION_TIMEOUT: ${{ secrets.DB_CONNECTION_TIMEOUT }}
        DB_LOCK_TIME_OUT: ${{ secrets.DB_LOCK_TIME_OUT }}
        DB_POOL_SIZE: ${{ secrets.DB_POOL_SIZE }}
        HUB_SERVICE_CACHEABLE: ${{ secrets.HUB_SERVICE_CACHEABLE }}
        KAKAO_API: ${{ secrets.KAKAO_API }}
        KAKAO_MOBILITY_API_KEY: ${{ secrets.KAKAO_MOBILITY_API_KEY }}
        PASSPORT_ALGO: ${{ secrets.PASSPORT_ALGO }}
        PASSPORT_EXPIRATION: ${{ secrets.PASSPORT_EXPIRATION }}
        PASSPORT_SECRET: ${{ secrets.PASSPORT_SECRET }}
      run: |
        DEPLOY_DIR="$HOME/deploy"
        LOG_DIR="$HOME/logs"
        
        mkdir -p $LOG_DIR
        
        nohup java -jar $DEPLOY_DIR/app.jar > $LOG_DIR/app.log 2>&1 &
        
        APP_PID=$!
        echo "Application started. PID: $APP_PID"
        
        sleep 10
        
        if lsof -ti:8088 > /dev/null; then
          echo "Application is running on port 8088"
        else
          echo "Application failed to start"
          tail -n 50 $LOG_DIR/app.log
          exit 1
        fi
    
    - name: Verify deployment
      run: |
        echo "Checking application status..."
        sleep 5
        
        if lsof -ti:8088 > /dev/null; then
          echo "Deployment successful - Application is running"
        else
          echo "Deployment failed - Application is not running"
          exit 1
        fi
